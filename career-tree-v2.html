<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Career Decision Tree v2 - Database Driven</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    body { margin: 0; padding: 0; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useCallback, useEffect } = React;

    // API Client
    const API_BASE_URL = 'http://localhost:5000/api';

    async function fetchPrograms(filters = {}) {
      const params = new URLSearchParams(filters);
      const response = await fetch(`${API_BASE_URL}/programs?${params}`);
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      return data.programs;
    }

    async function fetchCareerNodes() {
      const response = await fetch(`${API_BASE_URL}/career-nodes`);
      if (!response.ok) throw new Error(`API error: ${response.status}`);
      const data = await response.json();
      return data.nodes;
    }

    async function fetchEdges() {
      const response = await fetch(`${API_BASE_URL}/edges`);
      if (!response.ok) throw new Error(`Edges API error: ${response.status}`);
      const data = await response.json();
      return data.edges;
    }

    async function fetchNetworthCompact(lifestyle = 'frugal', familyYear = 5) {
      const response = await fetch(`${API_BASE_URL}/networth?compact=true&lifestyle=${lifestyle}&family_year=${familyYear}`);
      if (!response.ok) throw new Error(`Networth API error: ${response.status}`);
      return await response.json();
    }

    async function fetchProgramNetworth(programId, lifestyle = 'frugal', familyYear = 5) {
      const response = await fetch(`${API_BASE_URL}/networth/${programId}?lifestyle=${lifestyle}&family_year=${familyYear}`);
      if (!response.ok) throw new Error(`Networth API error: ${response.status}`);
      return await response.json();
    }

    async function fetchCareerNetworth(lifestyle = 'frugal', familyYear = 3) {
      const fy = Math.min(familyYear, 11); // Career paths use 1-11 (11=never), masters uses 1-13
      const response = await fetch(`${API_BASE_URL}/networth/career?compact=true&leaf_only=true&lifestyle=${lifestyle}&family_year=${fy}`);
      if (!response.ok) throw new Error(`Career Networth API error: ${response.status}`);
      return await response.json();
    }

    async function checkHealth() {
      try {
        const response = await fetch(`${API_BASE_URL}/health`);
        if (!response.ok) return false;
        const data = await response.json();
        return data.status === 'ok';
      } catch (error) {
        return false;
      }
    }

    // Tree Builder
    function buildTree(programs, careerNodes, networthData, careerNetworthData, edgesData) {
      const nodes = {};

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // BUILD EDGE MAP ‚Äî edgeMap[source_id][target_id] = probability
      // Used for conditional probability lookups in the UI
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      const edgeMap = {};
      for (const edge of (edgesData || [])) {
        if (!edgeMap[edge.source_id]) edgeMap[edge.source_id] = {};
        edgeMap[edge.source_id][edge.target_id] = edge.probability;
      }

      // Build networth lookup by program_id
      const nwLookup = {};
      if (networthData && networthData.programs) {
        for (const p of networthData.programs) {
          nwLookup[p.program_id] = p;
        }
      }
      const baseline = networthData ? networthData.baseline : null;

      // Build career networth lookup by node_id
      const careerNwLookup = {};
      if (careerNetworthData && careerNetworthData.results) {
        for (const r of careerNetworthData.results) {
          careerNwLookup[r.node_id] = r;
        }
      }
      const careerBaseline = careerNetworthData ? careerNetworthData.baseline : null;

      function groupBy(array, key) {
        return array.reduce((result, item) => {
          const group = item[key];
          if (!result[group]) result[group] = [];
          result[group].push(item);
          return result;
        }, {});
      }

      function makeId(str) {
        return str.toLowerCase().replace(/[^a-z0-9]/g, '_');
      }

      function truncate(str, maxLen) {
        if (!str) return '';
        return str.length > maxLen ? str.substring(0, maxLen - 3) + '...' : str;
      }

      const getFieldEmoji = (field) => ({ 'AI/ML': 'ü§ñ', 'CS/SWE': 'üíª', 'DS': 'üìä', 'Quant/FE': 'üí∞' }[field] || 'üéì');
      const getFieldColor = (field) => ({ 'AI/ML': '#00ff9f', 'CS/SWE': '#00e5ff', 'DS': '#a29bfe', 'Quant/FE': '#fdcb6e' }[field] || '#636e72');
      const getProb = (tier) => ({ tier1_free_europe: 0.55, tier2_elite_us: 0.10, tier3_midtier_global: 0.40, tier4_asia_regional: 0.45 }[tier] || 0.50);

      // Root node (stays in frontend ‚Äî personal info)
      nodes.root = {
        id: "root",
        phase: -1,
        label: "YOU TODAY\\nYear 0",
        salary: "220K PKR/mo\\nL3 Embedded AI",
        prob: 1.0,
        color: "#00ff9f",
        children: ["masters_root", "p1_promoted", "p1_notpromoted_stay", "p1_switch_local", "p1_trading", "p1_startup", "p1_freelance"]
      };

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // MASTERS PATH ‚Äî built dynamically from programs API data
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

      const tierGroups = groupBy(programs, 'funding_tier');
      const tierMeta = {
        tier1_free_europe: { label: "üéì Free/Low\\nEurope", prob: 0.25, color: "#a29bfe", note: "Germany, Switzerland. High ROI, easier admission (40-70%).", phase: 1 },
        tier2_elite_us: { label: "üèÜ Elite US\\nTop Tier", prob: 0.35, color: "#00e5ff", note: "MIT, Stanford, CMU. Hardest admission (5-15%).", phase: 1 },
        tier3_midtier_global: { label: "üåç Mid-Tier\\nGlobal", prob: 0.30, color: "#fd79a8", note: "Canada, UK, Australia. Moderate admission (30-50%).", phase: 1 },
        tier4_asia_regional: { label: "üè† Asia &\\nRegional", prob: 0.10, color: "#00cec9", note: "India, Singapore, HK. Lower cost.", phase: 1 }
      };

      nodes.masters_root = {
        id: "masters_root",
        phase: 0,
        label: "üéì Pursue\\nMasters Degree",
        salary: `${programs.length} programs\\n38 countries`,
        prob: 0.15,
        color: "#a29bfe",
        note: baseline ? `Baseline (no masters): $${baseline.total_networth_k.toFixed(0)}K over 12yr. Data from database.` : "Data from database.",
        children: Object.keys(tierMeta)
      };

      for (const [tierId, meta] of Object.entries(tierMeta)) {
        const tierProgs = tierGroups[tierId] || [];
        const fieldGroups = groupBy(tierProgs, 'field');
        const fieldIds = Object.keys(fieldGroups).map(f => `${tierId}_field_${makeId(f)}`);

        // Calculate tier average net benefit
        const tierNwValues = tierProgs.map(p => nwLookup[p.id]).filter(Boolean);
        const tierAvgBenefit = tierNwValues.length > 0
          ? tierNwValues.reduce((s, n) => s + n.net_benefit_k, 0) / tierNwValues.length
          : null;

        nodes[tierId] = {
          id: tierId,
          phase: meta.phase,
          label: meta.label,
          salary: tierAvgBenefit !== null
            ? `${tierProgs.length} programs\\nAvg: ${tierAvgBenefit >= 0 ? '+' : ''}$${tierAvgBenefit.toFixed(0)}K`
            : `${tierProgs.length} programs`,
          prob: meta.prob,
          color: meta.color,
          note: meta.note,
          children: fieldIds
        };

        for (const [field, fieldProgs] of Object.entries(fieldGroups)) {
          const fieldId = `${tierId}_field_${makeId(field)}`;
          const progIds = fieldProgs.map(p => `prog_${p.id}`);

          nodes[fieldId] = {
            id: fieldId,
            phase: 2,
            label: `${getFieldEmoji(field)} ${field}\\n${fieldProgs.length} programs`,
            salary: "Various unis",
            prob: 1.0 / Object.keys(fieldGroups).length,
            color: getFieldColor(field),
            note: `${fieldProgs.length} ${field} programs.`,
            children: progIds
          };

          for (const p of fieldProgs) {
            const progId = `prog_${p.id}`;
            const nw = nwLookup[p.id];
            const benefitStr = nw ? `${nw.net_benefit_k >= 0 ? '+' : ''}$${nw.net_benefit_k.toFixed(0)}K benefit` : '';
            const salary = [
              p.y1_salary_usd && `Y1: $${p.y1_salary_usd}K`,
              p.y10_salary_usd && `Y10: $${p.y10_salary_usd}K`,
              benefitStr
            ].filter(Boolean).join('\\n') || 'N/A';
            const note = `${p.university_name}, ${p.country}. ${p.tuition_usd ? `Tuition: $${p.tuition_usd}K. ` : ''}${nw ? `12yr Net Worth: $${nw.masters_networth_k.toFixed(0)}K. Net Benefit vs baseline: ${nw.net_benefit_k >= 0 ? '+' : ''}$${nw.net_benefit_k.toFixed(0)}K. Work: ${nw.work_country}${nw.work_city ? ' (' + nw.work_city + ')' : ''}. Eff. Tax: ${(nw.effective_tax_rate_y10 * 100).toFixed(0)}%.` : (p.net_10yr_usd ? `Net 10yr: $${p.net_10yr_usd}K.` : '')}`;

            nodes[progId] = {
              id: progId,
              phase: 3,
              label: `${truncate(p.university_name, 20)}\\n${truncate(p.program_name, 25)}`,
              salary,
              prob: getProb(p.funding_tier),
              color: tierMeta[p.funding_tier].color,
              note,
              networth: nw || null,
              programData: p,
              children: []
            };
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // MASTERS PATH EDGES ‚Äî add to edgeMap since these are
      // dynamically built (not in DB edges table)
      // root ‚Üí masters_root uses node prob (0.15)
      // masters_root ‚Üí tiers use tierMeta probs (sum to 1.0)
      // tier ‚Üí fields use 1/numFields (uniform, sum to 1.0)
      // field ‚Üí programs use getProb (admission probability)
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      if (!edgeMap['root']) edgeMap['root'] = {};
      edgeMap['root']['masters_root'] = 0.15;

      for (const [tierId, meta] of Object.entries(tierMeta)) {
        if (!edgeMap['masters_root']) edgeMap['masters_root'] = {};
        edgeMap['masters_root'][tierId] = meta.prob;

        const tierNode = nodes[tierId];
        if (tierNode) {
          if (!edgeMap[tierId]) edgeMap[tierId] = {};
          for (const fieldId of tierNode.children) {
            const fieldNode = nodes[fieldId];
            edgeMap[tierId][fieldId] = fieldNode ? fieldNode.prob : 1.0;

            if (fieldNode) {
              if (!edgeMap[fieldId]) edgeMap[fieldId] = {};
              for (const progId of fieldNode.children) {
                const progNode = nodes[progId];
                edgeMap[fieldId][progId] = progNode ? progNode.prob : 0.5;
              }
            }
          }
        }
      }

      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      // ALL OTHER NODES ‚Äî loaded from career_nodes API
      // Career progression, trading, startup, freelancing paths
      // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
      for (const cn of careerNodes) {
        const cnw = careerNwLookup[cn.id];
        const isLeaf = !(cn.children && cn.children.length > 0);
        // Build enhanced salary display for leaf nodes with networth data
        let salaryDisplay = cn.salary || '';
        if (isLeaf && cnw) {
          const benefitStr = `${cnw.net_benefit_k >= 0 ? '+' : ''}$${cnw.net_benefit_k.toFixed(0)}K benefit`;
          const parts = [
            cnw.y1_income_k && `Y1: $${cnw.y1_income_k.toFixed(0)}K`,
            cnw.y10_income_k && `Y10: $${cnw.y10_income_k.toFixed(0)}K`,
            benefitStr
          ].filter(Boolean);
          salaryDisplay = parts.join('\\n') || salaryDisplay;
        }
        // Build enhanced note for leaf nodes with networth data
        let noteDisplay = cn.note || '';
        if (isLeaf && cnw) {
          noteDisplay = `${cn.note || cn.label}. 10yr Net Worth: $${cnw.path_networth_k.toFixed(0)}K. Net Benefit vs baseline: ${cnw.net_benefit_k >= 0 ? '+' : ''}$${cnw.net_benefit_k.toFixed(0)}K. Eff. Tax (Y10): ${(cnw.effective_tax_rate_y10 * 100).toFixed(0)}%.`;
        }
        nodes[cn.id] = {
          id: cn.id,
          phase: cn.phase,
          label: cn.label,
          salary: salaryDisplay,
          prob: cn.prob,
          color: cn.color,
          note: noteDisplay,
          node_type: cn.node_type,
          children: cn.children || [],
          networth: cnw || null
        };
      }

      return { nodes, edgeMap };
    }

    // Main Component
    function CareerTreeV2() {
      const [nodes, setNodes] = useState(null);
      const [edgeMap, setEdgeMap] = useState({});
      const [selectedPath, setSelectedPath] = useState([]);
      const [hoveredNode, setHoveredNode] = useState(null);
      const [activeLeaf, setActiveLeaf] = useState(null);
      const [collapsedNodes, setCollapsedNodes] = useState(new Set());
      const [lifestyle, setLifestyle] = useState('frugal');
      const [familyYear, setFamilyYear] = useState(5);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        async function load() {
          try {
            if (!(await checkHealth())) throw new Error('API not responding. Start backend: cd backend && python3 app.py');
            const [programs, careerNodes, networthData, careerNetworthData, edgesData] = await Promise.all([
              fetchPrograms(),
              fetchCareerNodes(),
              fetchNetworthCompact(lifestyle, familyYear),
              fetchCareerNetworth(lifestyle, familyYear),
              fetchEdges()
            ]);
            const treeData = buildTree(programs, careerNodes, networthData, careerNetworthData, edgesData);
            setNodes(treeData.nodes);
            setEdgeMap(treeData.edgeMap);
            setLoading(false);
          } catch (err) {
            setError(err.message);
            setLoading(false);
          }
        }
        load();
      }, [lifestyle, familyYear]);

      const isDescendantOf = useCallback((nodeId, ancestorId) => {
        if (!nodes) return false;
        const ancestor = nodes[ancestorId];
        if (!ancestor) return false;
        for (const childId of ancestor.children || []) {
          if (childId === nodeId) return true;
          if (isDescendantOf(nodeId, childId)) return true;
        }
        return false;
      }, [nodes]);

      const isInPath = useCallback((id) => selectedPath.includes(id), [selectedPath]);
      const isHighlighted = useCallback((id) => {
        if (selectedPath.length === 0) return true;
        if (selectedPath.indexOf(id) !== -1) return true;
        return isDescendantOf(id, selectedPath[selectedPath.length - 1]);
      }, [selectedPath, isDescendantOf]);

      const isNodeVisible = useCallback((nodeId) => {
        for (const id of Object.keys(nodes || {})) {
          if (collapsedNodes.has(id) && isDescendantOf(nodeId, id)) return false;
        }
        return true;
      }, [collapsedNodes, isDescendantOf, nodes]);

      const toggleCollapse = useCallback((id, e) => {
        e.stopPropagation();
        setCollapsedNodes(prev => {
          const next = new Set(prev);
          next.has(id) ? next.delete(id) : next.add(id);
          return next;
        });
      }, []);

      const collapseAll = useCallback(() => {
        if (!nodes) return;
        const allParents = new Set(Object.keys(nodes).filter(id => id !== 'root' && (nodes[id].children || []).length > 0));
        setCollapsedNodes(allParents);
      }, [nodes]);

      const expandAll = useCallback(() => {
        setCollapsedNodes(new Set());
      }, []);

      const handleNodeClick = useCallback((id) => {
        if (!nodes) return;
        if (id === "root") { setSelectedPath([]); setActiveLeaf(null); return; }
        const node = nodes[id];
        const parentInPath = selectedPath.length === 0 || (nodes[selectedPath[selectedPath.length - 1]]?.children || []).includes(id);
        if (parentInPath) {
          const idx = selectedPath.indexOf(id);
          if (idx !== -1) {
            setSelectedPath(selectedPath.slice(0, idx + 1));
            setActiveLeaf((node.children || []).length === 0 ? id : null);
          } else {
            setSelectedPath([...selectedPath, id]);
            setActiveLeaf((node.children || []).length === 0 ? id : null);
          }
        } else {
          setSelectedPath([id]);
          setActiveLeaf((node.children || []).length === 0 ? id : null);
        }
      }, [nodes, selectedPath]);

      if (loading) return <div style={{minHeight:"100vh",background:"#070b14",color:"#e8eaf6",display:"flex",alignItems:"center",justifyContent:"center",fontSize:"24px"}}>‚è≥ Loading...</div>;
      if (error) return <div style={{minHeight:"100vh",background:"#070b14",color:"#ef4444",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:"20px",padding:"40px"}}><div style={{fontSize:"32px"}}>‚ùå Error</div><div style={{maxWidth:"600px",textAlign:"center",background:"#1a0a0a",padding:"20px",borderRadius:"10px",border:"1px solid #ef4444"}}>{error}</div></div>;
      if (!nodes) return null;

      const phaseNodes = [-1, 0, 1, 2, 3].map(ph => Object.values(nodes).filter(n => n.phase === ph && isNodeVisible(n.id)));

      // Helper: get edge probability for a parent‚Üíchild transition
      // Falls back to node.prob if no edge data exists
      const getEdgeProb = (parentId, childId) => {
        if (edgeMap[parentId] && edgeMap[parentId][childId] !== undefined) {
          return edgeMap[parentId][childId];
        }
        return nodes[childId]?.prob || 1;
      };

      // Cumulative path probabilities using edge-based conditional probs
      // For each node in selectedPath, find its parent (previous in path, or "root")
      const pathProbs = selectedPath.reduce((acc, id, i) => {
        const parentId = i === 0 ? 'root' : selectedPath[i - 1];
        const edgeProb = getEdgeProb(parentId, id);
        acc.push((i === 0 ? 1 : acc[i-1]) * edgeProb);
        return acc;
      }, []);

      // Helper: determine which parent a node has in the current selectedPath
      // Returns the parent node ID from selectedPath, or "root" if the node
      // is a direct child of root, or null if no parent context is known
      const getNodeParentInPath = (nodeId) => {
        // Walk selectedPath to find which node has nodeId as a child
        for (let i = selectedPath.length - 1; i >= 0; i--) {
          const pathNode = nodes[selectedPath[i]];
          if (pathNode && (pathNode.children || []).includes(nodeId)) return selectedPath[i];
        }
        // Check if root has this node as child
        if (nodes.root && (nodes.root.children || []).includes(nodeId)) return 'root';
        return null;
      };
      const leafNode = activeLeaf ? nodes[activeLeaf] : null;

      // Detect which path is selected using node_type from API data
      const onMastersPath = selectedPath.includes("masters_root") || selectedPath.some(id => {
        const nid = nodes[id]?.id || '';
        return nid.includes("tier") || nid.includes("field") || nid.startsWith("prog_");
      });
      const onTradingPath = selectedPath.some(id => nodes[id]?.node_type === 'trading');
      const onStartupPath = selectedPath.some(id => nodes[id]?.node_type === 'startup');
      const onFreelancePath = selectedPath.some(id => nodes[id]?.node_type === 'freelance');

      // Dynamic phase labels based on path
      let PHASE_LABELS;
      if (onMastersPath) {
        PHASE_LABELS = ["Immediate Decisions ¬∑ Year 0", "Masters Step 1 ¬∑ Funding Tier", "Masters Step 2 ¬∑ Field", "Masters Step 3 ¬∑ Program"];
      } else if (onTradingPath) {
        PHASE_LABELS = ["Side Hustle ¬∑ Start Trading", "Specialization ¬∑ Yr 0‚Äì1", "Outcomes ¬∑ Yr 1‚Äì3", "Final ¬∑ Yr 3‚Äì7"];
      } else if (onStartupPath) {
        PHASE_LABELS = ["Side Hustle ¬∑ Start Building", "Product Type ¬∑ Yr 0‚Äì1", "Traction ¬∑ Yr 1‚Äì3", "Final ¬∑ Yr 3‚Äì7"];
      } else if (onFreelancePath) {
        PHASE_LABELS = ["Side Hustle ¬∑ Start Freelancing", "Channel ¬∑ Yr 0‚Äì1", "Growth ¬∑ Yr 1‚Äì3", "Final ¬∑ Yr 3‚Äì7"];
      } else {
        PHASE_LABELS = ["Immediate Decisions ¬∑ Year 0", "Phase 1 ¬∑ Yr 0‚Äì2", "Phase 2 ¬∑ Yr 2‚Äì4", "Phase 3 ¬∑ Yr 4‚Äì7 (Final)"];
      }
      const PHASE_COLORS = ["#00e5ff22", "#00ff9f22", "#a29bfe22", "#fd79a822"];

      const NodeCard = ({ node, inPath, highlighted, onClick, onHover, hovered, cumProb, edgeProb, isLeaf, collapsed, onToggleCollapse, hasChildren }) => {
        const getProbColor = (prob) => prob >= 0.55 ? "#00ff9f" : prob >= 0.35 ? "#fdcb6e" : "#ff7675";
        // Use edge probability if available, fall back to node.prob
        const displayProb = edgeProb !== null && edgeProb !== undefined ? edgeProb : node.prob;
        const nw = node.networth;
        const benefitColor = nw ? (nw.net_benefit_k >= 200 ? "#00ff9f" : nw.net_benefit_k >= 0 ? "#fdcb6e" : "#ff7675") : null;
        return (
          <div onClick={onClick} onMouseEnter={() => onHover(node.id)} onMouseLeave={() => onHover(null)} style={{background:inPath?`${node.color}18`:hovered?"#131c2e":"#0c1220",border:`1.5px solid ${inPath?node.color:hovered?node.color+"88":"#1e2a3a"}`,borderRadius:9,padding:"9px 10px",cursor:"pointer",opacity:highlighted?1:0.28,transition:"all 0.15s ease",boxShadow:inPath?`0 0 12px ${node.color}33`:"none",minHeight:84,position:"relative"}}>
            {hasChildren && !isLeaf && <div onClick={(e)=>onToggleCollapse(node.id,e)} style={{position:"absolute",top:-1,left:-1,background:collapsed?"#1a2744":"#2d4a66",borderRadius:"8px 0 4px 0",padding:"2px 6px",fontSize:11,color:"#93c5fd",cursor:"pointer",fontWeight:"bold"}} title={collapsed?"Expand":"Collapse"}>{collapsed?"+":"‚àí"}</div>}
            {isLeaf && nw && <div style={{position:"absolute",top:-1,right:-1,background:nw.net_benefit_k>=0?"#0a2e1a":"#2e0a0a",borderRadius:"0 8px 0 4px",padding:"1px 5px",fontSize:8,color:benefitColor,fontWeight:"bold"}}>{nw.net_benefit_k>=0?"+":""}${nw.net_benefit_k.toFixed(0)}K</div>}
            {isLeaf && !nw && <div style={{position:"absolute",top:-1,right:-1,background:"#1a2744",borderRadius:"0 8px 0 4px",padding:"1px 5px",fontSize:8,color:"#4a90d9"}}>END</div>}
            <div style={{fontSize:10.5,fontWeight:700,color:inPath?node.color:hovered?node.color+"cc":"#94a3b8",lineHeight:1.35,marginBottom:5,whiteSpace:"pre-line"}}>{node.label.replace(/\\n/g,"\n")}</div>
            <div style={{fontSize:9.5,color:"#64748b",lineHeight:1.3,whiteSpace:"pre-line"}}>{node.salary.replace(/\\n/g,"\n").split("\n").map((line, i) => {
              if (line.includes("benefit")) return <span key={i} style={{color:benefitColor,fontWeight:700}}>{line}</span>;
              return <span key={i}>{line}{i < node.salary.split("\\n").length - 1 ? "\n" : ""}</span>;
            })}</div>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginTop:6}}>
              <div style={{fontSize:9,color:getProbColor(displayProb),background:`${getProbColor(displayProb)}18`,borderRadius:4,padding:"1px 5px"}}>{(displayProb*100).toFixed(0)}% branch</div>
              {cumProb!==null && <div style={{fontSize:9,color:"#4a5568"}}>{(cumProb*100).toFixed(1)}% overall</div>}
            </div>
          </div>
        );
      };

      // Program detail panel
      const ProgramDetail = ({ node }) => {
        const nw = node.networth;
        const prog = node.programData;
        if (!nw || !prog) return <div style={{background:"#0c1220",border:"1px solid #1e2a3a",borderRadius:12,padding:"20px",marginTop:20}}><div style={{color:"#94a3b8",fontSize:13}}>Select a program node to see net worth details.</div></div>;

        const benefitColor = nw.net_benefit_k >= 200 ? "#00ff9f" : nw.net_benefit_k >= 0 ? "#fdcb6e" : "#ff7675";

        return (
          <div style={{background:"#0c1220",border:"1px solid #1e2a3a",borderRadius:12,padding:"20px 24px",marginTop:20}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:16}}>
              <div>
                <div style={{fontSize:16,fontWeight:700,color:"#e8eaf6"}}>{prog.university_name}</div>
                <div style={{fontSize:13,color:"#94a3b8",marginTop:2}}>{prog.program_name} ¬∑ {prog.field} ¬∑ {prog.country}</div>
              </div>
              <div style={{textAlign:"right"}}>
                <div style={{fontSize:24,fontWeight:700,color:benefitColor}}>{nw.net_benefit_k >= 0 ? "+" : ""}${nw.net_benefit_k.toFixed(0)}K</div>
                <div style={{fontSize:10,color:"#64748b"}}>12yr net benefit vs baseline</div>
              </div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:12,marginTop:16}}>
              {[
                { label: "Tuition", value: `$${(prog.tuition_usd || 0).toFixed(0)}K`, color: "#ff7675" },
                { label: "Total Study Cost", value: `$${nw.total_study_cost_k.toFixed(0)}K`, color: "#ff7675" },
                { label: "Y1 Salary", value: `$${nw.y1_salary_k.toFixed(0)}K`, color: "#00e5ff" },
                { label: "Y10 Salary", value: `$${nw.y10_salary_k.toFixed(0)}K`, color: "#00e5ff" },
                { label: "12yr Net Worth", value: `$${nw.masters_networth_k.toFixed(0)}K`, color: "#a29bfe" },
                { label: "Baseline NW", value: `$${nw.baseline_networth_k.toFixed(0)}K`, color: "#64748b" },
                { label: "Work Location", value: `${nw.work_country}${nw.work_city ? ' (' + nw.work_city + ')' : ''}`, color: "#94a3b8" },
                { label: "Eff. Tax (Y10)", value: `${(nw.effective_tax_rate_y10 * 100).toFixed(1)}%`, color: "#fdcb6e" },
              ].map((item, i) => (
                <div key={i} style={{background:"#131c2e",borderRadius:8,padding:"8px 10px"}}>
                  <div style={{fontSize:9,color:"#64748b",letterSpacing:"0.05em",marginBottom:3}}>{item.label}</div>
                  <div style={{fontSize:13,fontWeight:600,color:item.color}}>{item.value}</div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      // Career path detail panel (trading, startup, freelance, career)
      const CareerNodeDetail = ({ node }) => {
        const nw = node.networth;
        if (!nw) return <div style={{background:"#0c1220",border:"1px solid #1e2a3a",borderRadius:12,padding:"20px",marginTop:20}}><div style={{color:"#94a3b8",fontSize:13}}>No net worth data available for this node.</div></div>;

        const benefitColor = nw.net_benefit_k >= 200 ? "#00ff9f" : nw.net_benefit_k >= 0 ? "#fdcb6e" : "#ff7675";
        const typeLabel = (nw.node_type || '').charAt(0).toUpperCase() + (nw.node_type || '').slice(1);
        const typeColors = { trading: "#fdcb6e", startup: "#00ff9f", freelance: "#00e5ff", career: "#a29bfe" };
        const typeColor = typeColors[nw.node_type] || "#94a3b8";

        return (
          <div style={{background:"#0c1220",border:"1px solid #1e2a3a",borderRadius:12,padding:"20px 24px",marginTop:20}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",flexWrap:"wrap",gap:16}}>
              <div>
                <div style={{display:"flex",alignItems:"center",gap:8}}>
                  <div style={{fontSize:16,fontWeight:700,color:"#e8eaf6"}}>{(nw.label || node.label || '').replace(/\\n/g, ' ')}</div>
                  <span style={{fontSize:10,background:`${typeColor}22`,color:typeColor,padding:"1px 8px",borderRadius:4,fontWeight:600}}>{typeLabel}</span>
                </div>
                {nw.note && <div style={{fontSize:12,color:"#94a3b8",marginTop:4,maxWidth:500}}>{nw.note}</div>}
              </div>
              <div style={{textAlign:"right"}}>
                <div style={{fontSize:24,fontWeight:700,color:benefitColor}}>{nw.net_benefit_k >= 0 ? "+" : ""}${nw.net_benefit_k.toFixed(0)}K</div>
                <div style={{fontSize:10,color:"#64748b"}}>10yr net benefit vs baseline</div>
              </div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:12,marginTop:16}}>
              {[
                { label: "Y1 Income", value: `$${nw.y1_income_k.toFixed(0)}K/yr`, color: "#00e5ff" },
                { label: "Y5 Income", value: `$${nw.y5_income_k.toFixed(0)}K/yr`, color: "#00e5ff" },
                { label: "Y10 Income", value: `$${nw.y10_income_k.toFixed(0)}K/yr`, color: "#00e5ff" },
                nw.initial_capital_k > 0 ? { label: "Initial Capital", value: `$${nw.initial_capital_k.toFixed(1)}K`, color: "#ff7675" } : null,
                nw.ongoing_annual_k > 0 ? { label: "Ongoing Cost/yr", value: `$${nw.ongoing_annual_k.toFixed(1)}K`, color: "#ff7675" } : null,
                { label: "10yr Savings", value: `$${nw.total_work_savings_k.toFixed(0)}K`, color: "#a29bfe" },
                { label: "10yr Net Worth", value: `$${nw.path_networth_k.toFixed(0)}K`, color: "#a29bfe" },
                { label: "Baseline NW", value: `$${nw.baseline_networth_k.toFixed(0)}K`, color: "#64748b" },
                { label: "Eff. Tax (Y1)", value: `${(nw.effective_tax_rate_y1 * 100).toFixed(1)}%`, color: "#fdcb6e" },
                { label: "Eff. Tax (Y10)", value: `${(nw.effective_tax_rate_y10 * 100).toFixed(1)}%`, color: "#fdcb6e" },
                nw.income_floor_usd ? { label: "Income Floor", value: `$${nw.income_floor_usd}/mo`, color: "#94a3b8" } : null,
                nw.income_ceiling_usd ? { label: "Income Ceiling", value: `$${nw.income_ceiling_usd}/mo`, color: "#94a3b8" } : null,
              ].filter(Boolean).map((item, i) => (
                <div key={i} style={{background:"#131c2e",borderRadius:8,padding:"8px 10px"}}>
                  <div style={{fontSize:9,color:"#64748b",letterSpacing:"0.05em",marginBottom:3}}>{item.label}</div>
                  <div style={{fontSize:13,fontWeight:600,color:item.color}}>{item.value}</div>
                </div>
              ))}
            </div>
          </div>
        );
      };

      return (
        <div style={{minHeight:"100vh",background:"#070b14",color:"#e8eaf6",fontFamily:"'DM Mono','Fira Code',monospace",padding:"24px 16px",overflowX:"auto"}}>
          <div style={{textAlign:"center",marginBottom:28}}>
            <div style={{fontFamily:"'Bebas Neue','Impact',sans-serif",fontSize:"clamp(22px,4vw,44px)",letterSpacing:"0.12em",background:"linear-gradient(90deg,#00e5ff,#00ff9f,#a29bfe)",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",marginBottom:4}}>CAREER DECISION TREE v2</div>
            <div style={{fontSize:12,color:"#636e72",letterSpacing:"0.2em"}}>{Object.keys(nodes).length} NODES ¬∑ DATABASE-DRIVEN</div>
            <div style={{fontSize:11,color:"#4a5568",marginTop:6}}>Click nodes to trace path ¬∑ Click ‚àí / + to collapse/expand</div>
            <div style={{display:"flex",gap:8,justifyContent:"center",marginTop:10}}>
              <button onClick={collapseAll} style={{background:"#1a2744",border:"1px solid #2d4a66",borderRadius:6,padding:"4px 12px",fontSize:11,color:"#93c5fd",cursor:"pointer",fontFamily:"inherit",fontWeight:"bold"}}>‚àí Collapse All</button>
              <button onClick={expandAll} style={{background:"#1a2744",border:"1px solid #2d4a66",borderRadius:6,padding:"4px 12px",fontSize:11,color:"#93c5fd",cursor:"pointer",fontFamily:"inherit",fontWeight:"bold"}}>+ Expand All</button>
            </div>
            <div style={{display:"flex",gap:6,justifyContent:"center",alignItems:"center",marginTop:10}}>
              <span style={{fontSize:11,color:lifestyle==='frugal'?"#00ff9f":"#4a5568",fontWeight:lifestyle==='frugal'?700:400,cursor:"pointer",transition:"all 0.15s"}} onClick={()=>setLifestyle('frugal')}>Frugal</span>
              <div onClick={()=>setLifestyle(prev=>prev==='frugal'?'comfortable':'frugal')} style={{width:40,height:20,borderRadius:10,background:lifestyle==='comfortable'?"#a29bfe":"#1e2a3a",border:"1px solid #2d4a66",cursor:"pointer",position:"relative",transition:"background 0.2s"}}>
                <div style={{width:16,height:16,borderRadius:8,background:"#e8eaf6",position:"absolute",top:1,left:lifestyle==='comfortable'?21:1,transition:"left 0.2s"}}/>
              </div>
              <span style={{fontSize:11,color:lifestyle==='comfortable'?"#a29bfe":"#4a5568",fontWeight:lifestyle==='comfortable'?700:400,cursor:"pointer",transition:"all 0.15s"}} onClick={()=>setLifestyle('comfortable')}>Comfortable</span>
            </div>
            <div style={{display:"flex",flexDirection:"column",alignItems:"center",marginTop:10,gap:4}}>
              <div style={{display:"flex",alignItems:"center",gap:10}}>
                <span style={{fontSize:11,color:"#64748b"}}>Family Year</span>
                <input type="range" min={1} max={13} value={familyYear} onChange={e=>setFamilyYear(Number(e.target.value))} style={{width:160,accentColor:"#fdcb6e",cursor:"pointer"}}/>
                <span style={{fontSize:12,fontWeight:700,color:"#fdcb6e",minWidth:20,textAlign:"center"}}>{familyYear <= 12 ? familyYear : "‚àû"}</span>
              </div>
              <div style={{fontSize:10,color:"#94a3b8"}}>
                {familyYear === 13 ? "Never marry ‚Äî single costs entire timeline" :
                 familyYear === 1 ? `Year 1 ‚Äî Family from the start` :
                 familyYear === 2 ? `Year 2 ‚Äî Family early on` :
                 familyYear === 3 ? `Year 3 ‚Äî Family after settling in` :
                 `Year ${familyYear} ‚Äî Family at year ${familyYear}`}
              </div>
            </div>
            <div style={{fontSize:10,color:"#00ff9f",marginTop:8}}>‚úì Connected to API ¬∑ Edge Probabilities ¬∑ {lifestyle === 'frugal' ? 'Frugal' : 'Comfortable'} ¬∑ Family {familyYear <= 12 ? `at Yr ${familyYear}` : 'Never'}</div>
          </div>

          <div style={{display:"flex",gap:0,alignItems:"flex-start",overflowX:"auto",paddingBottom:24,minWidth:"900px"}}>
            <div style={{display:"flex",flexDirection:"column",alignItems:"center",minWidth:140,paddingTop:60}}>
              <NodeCard node={nodes.root} inPath={true} highlighted={true} onClick={()=>handleNodeClick("root")} onHover={setHoveredNode} hovered={hoveredNode==="root"} cumProb={1.0} edgeProb={1.0} collapsed={collapsedNodes.has("root")} onToggleCollapse={toggleCollapse} hasChildren={(nodes.root.children||[]).length>0}/>
            </div>
            <div style={{display:"flex",alignItems:"center",justifyContent:"center",minWidth:24,color:"#1e3a5f",fontSize:18,flexShrink:0,alignSelf:"center"}}>‚Ä∫</div>
            {[0,1,2,3].map(phaseIdx=><React.Fragment key={phaseIdx}><div style={{display:"flex",alignItems:"stretch"}}><div style={{display:"flex",flexDirection:"column",minWidth:155,background:PHASE_COLORS[phaseIdx],borderRadius:12,padding:"8px 6px",gap:10}}><div style={{fontSize:9,letterSpacing:"0.18em",color:"#64748b",textAlign:"center",borderBottom:"1px solid #1e2a3a",paddingBottom:6,marginBottom:2}}>{PHASE_LABELS[phaseIdx]}</div>{phaseNodes[phaseIdx+1].map(node=>{const cumIdx=selectedPath.indexOf(node.id);const cumP=cumIdx!==-1?pathProbs[cumIdx]:null;const parentId=getNodeParentInPath(node.id);const eProb=parentId!==null?getEdgeProb(parentId,node.id):null;return <NodeCard key={node.id} node={node} inPath={isInPath(node.id)} highlighted={isHighlighted(node.id)} onClick={()=>handleNodeClick(node.id)} onHover={setHoveredNode} hovered={hoveredNode===node.id} cumProb={cumP} edgeProb={eProb} isLeaf={(node.children||[]).length===0} collapsed={collapsedNodes.has(node.id)} onToggleCollapse={toggleCollapse} hasChildren={(node.children||[]).length>0}/>})}</div></div>{phaseIdx<3 && <div style={{display:"flex",alignItems:"center",justifyContent:"center",minWidth:24,color:"#1e3a5f",fontSize:18,flexShrink:0,alignSelf:"center"}}>‚Ä∫</div>}</React.Fragment>)}
          </div>

          {activeLeaf && nodes[activeLeaf] && nodes[activeLeaf].networth && nodes[activeLeaf].programData && (
            <ProgramDetail node={nodes[activeLeaf]} />
          )}

          {activeLeaf && nodes[activeLeaf] && nodes[activeLeaf].networth && !nodes[activeLeaf].programData && (
            <CareerNodeDetail node={nodes[activeLeaf]} />
          )}

          {hoveredNode && nodes[hoveredNode] && nodes[hoveredNode].note && !activeLeaf && (
            <div style={{background:"#0c1220",border:"1px solid #1e2a3a",borderRadius:8,padding:"12px 16px",marginTop:16,fontSize:11,color:"#94a3b8",maxWidth:700}}>
              {nodes[hoveredNode].note}
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<CareerTreeV2 />);
  </script>
</body>
</html>
